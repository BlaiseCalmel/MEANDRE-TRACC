<!DOCTYPE html>
<html lang="fr">
    <head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Abigail</title>

	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">

	<!-- topojson for json -->
	<script src="//d3js.org/topojson.v1.min.js"></script>
	<!-- geotoolbox for geo transformation -->
	<script src="https://cdn.jsdelivr.net/npm/geotoolbox" charset="utf-8"></script>

	<!-- d3 -->
	<script src="https://d3js.org/d3.v6.min.js"></script>
	<!-- d3 interpolate path -->
	<script src="https://unpkg.com/d3-interpolate-path@2.3.0/build/d3-interpolate-path.js"></script>
	

	<!-- Slider -->
	<link href="src/nouislider.css" rel="stylesheet">
	<script src="src/nouislider.js"></script>
	
	<style>

         body {
             margin: 0;
             padding: 0;
             display: flex;
             height: 100vh;
             overflow: hidden;
	     background-color: #262A2B;
	     font-family: "Poppins",sans-serif;
         }

         #menu {
	     pointer-events: auto;
             width: 10px;
             background-color: #CCC;
             color: #fff;
             padding: 10px;
             box-shadow: 2px 0px 5px rgba(0, 0, 0, 0.5);
             transition: width 0.3s ease;
             position: absolute;
             top: 0;
             bottom: 0;
             z-index: 2;
         }

         #menu.expanded {
	     pointer-events: auto;
             width: 250px;
         }

         .hidden {
             display: none;
         }

         #menu-button {
             cursor: pointer;
             z-index: 3;
             position: absolute;
             top: 10px;
             left: 10px;
         }

         #map-container {
	     left: 20px;
	     width: 100vh;
	     height: 100vh;
	     position: relative;
	     overflow: hidden;
         }

	 #range-container {
	     left: 5px;
	     top: 50px;
	     width: 100%;
	     height: 10px;
	     position: relative;
         }



	</style>
    </head>
    <body>
	<div id="menu-button" onclick="toggleMenu()">M</div>
	

        <div id="menu">
            <div id="menuExpand" class="hidden">
                <p>This is the content of the menu.</p>
		<div id="range-container">
		    <div id="range"></div>
		</div>
            </div>
        </div>

	
	<div id="map-container">
            <svg id="geoJSONsvg_france"></svg>
	</div>
	
	<script>
	 
	 

	 function toggleMenu() {
	     const menu = document.getElementById("menu");
	     const menuExpand = document.getElementById("menuExpand");

	     if (menu.classList.contains("expanded")) {
		 menu.classList.remove("expanded");
		 menuExpand.classList.add("hidden");
	     } else {
		 menu.classList.add("expanded");
		 menuExpand.classList.remove("hidden");
	     }
	 }

	 

	 const geoJSONfiles = [
	     "data/france.geo.json",
	     "data/river.geo.json",
	     "data/entiteHydro.geo.json"
	 ];

	 function loadGeoJSON(fileURL) {
	     return d3.json(fileURL)
		      .then(data => data)
		      .catch(error => {
			  console.error("Error loading geojson file :", error);
			  throw error;
		      });
	 }

	 const promises = geoJSONfiles.map(fileURL => loadGeoJSON(fileURL));

	 Promise.all(promises)
		.then(geoJSONdata => {
		    const geoJSONdata_france = geoJSONdata[0];
		    const geoJSONdata_river = geoJSONdata[1];
		    const geoJSONdata_entiteHydro = geoJSONdata[2];
		    drawGeoJSON(geoJSONdata_france, geoJSONdata_river, geoJSONdata_entiteHydro);
		})
		.catch(error => {
		    console.error("Error loading or processing GeoJSON files:", error);
		});

	 

	 function drawGeoJSON(geoJSONdata_france, geoJSONdata_river, geoJSONdata_entiteHydro) {
	     if (geoJSONdata_france && geoJSONdata_river) {

		 const fill_entiteHydro = "transparent";
		 const stroke_entiteHydro = "#555";
		 
		 const fill_france = "transparent";
		 const stroke_france = "#E8E6E3";
		 const stroke_river = "#9A9286";

		 const minZoom = 1;
		 const maxZoom = 4;
		 const maxPan = 0;

		 const transitionDuration = 500;
		 
		 const k_simplify_ref = 0.1;
		 let k_simplify = k_simplify_ref;

		 const riverLength_max = 0.4;
		 const riverLength_min = 0;
		 let riverLength = riverLength_max;

		 const strokeWith_river_max = 0.9;
		 const strokeWith_river_min = 0.1;
		 
		 let width = window.innerHeight;
		 let height = window.innerHeight;

		 

		 const zoom = d3.zoom()
				.scaleExtent([minZoom, maxZoom])
				.on("zoom", function (event) { 
				    riverLength = riverLength_max - (event.transform.k - minZoom)/(maxZoom-minZoom)*(riverLength_max-riverLength_min);
				    k_simplify = k_simplify_ref + (event.transform.k - minZoom)/(maxZoom-minZoom)*(1-k_simplify_ref);

				    redrawMap();
				    
				    svg.attr("transform", event.transform);
				    svg.style("width", width * event.transform.k + "px");
				    svg.style("height", height * event.transform.k + "px");
				});


		 const projection = d3.geoMercator()
				      .center(geoJSONdata_france.features[0].properties.centroid);
		 
		 const svg = d3.select("#geoJSONsvg_france")
			       .attr("width", "100%")
			       .attr("height", "100%")
			       .call(zoom)
			       .append("g");


		 
		 

		 function handleResize() {
		     width = window.innerHeight;
		     height = window.innerHeight;

		     zoom.translateExtent([[-width*maxPan, -height*maxPan], [width*(1+maxPan), height*(1+maxPan)]]);
		     svg.attr("width", width).attr("height", height);
		     projection.scale([height*3.2]).translate([width / 2, height / 2]);

		     redrawMap();
		 }

		 window.addEventListener("resize", handleResize.bind(null, k_simplify, riverLength));


		 
		 function redrawMap() {
		     const simplifiedGeoJSON_france = geotoolbox.simplify(geoJSONdata_france, { k: k_simplify, merge: false });
		     const selectedGeoJSON_river = geotoolbox.filter(geoJSONdata_river, (d) => d.norm >= riverLength);
		     const simplifiedselectedGeoJSON_river = geotoolbox.simplify(selectedGeoJSON_river, { k: k_simplify, merge: false });
		     
		     svg.selectAll("path.france")
			.data(simplifiedGeoJSON_france.features)
			.join("path")
			.attr("class", "france")
			.attr("d", pathGenerator)
			.transition()
			.duration(1000)
			.attr("fill", fill_france)
			.attr("stroke", stroke_france)
			.attr("stroke-width", 1)
			.attr("stroke-linejoin", "miter")
			.attr("stroke-miterlimit", 1);

		     svg.selectAll("path.river")
			.data(simplifiedselectedGeoJSON_river.features)
			.join("path")
			.attr("class", "river")
			.attr("d", pathGenerator)
			.transition()
			.duration(1000)
			.attr("fill", "transparent")
			.attr("stroke", stroke_river)
			.attr("stroke-width", function(d) {
			    return strokeWith_river_max - (1 - d.properties.norm) * (strokeWith_river_max - strokeWith_river_min);
			})
			.attr("stroke-linejoin", "miter")
			.attr("stroke-linecap", "round")
			.attr("stroke-miterlimit", 1);
		 }



		 const pathGenerator = d3.geoPath(projection);

		 redrawMap();
		 handleResize();
		 

		 return svg.node();
	     }
	 }




	 var range = document.getElementById('range');

	 noUiSlider.create(range, {

	     range: {
		 'min': 1300,
		 'max': 3250
	     },

	     step: 150,

	     // Handles start at ...
	     start: [1450, 2050, 2350, 3000],

	     // ... must be at least 300 apart
	     margin: 300,

	     // ... but no more than 600
	     limit: 600,

	     // Display colored bars between handles
	     connect: true,

	     // Move handle on tap, bars are draggable
	     behaviour: 'tap-drag',
	     tooltips: true,

	     // Show a scale with the slider
	     pips: {
		 mode: 'steps',
		 stepped: true,
		 density: 4
	     }
	 });

	 
	</script>
    </body>
</html>
